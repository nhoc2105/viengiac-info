name: Reusable - Compile Android

on:
  workflow_call:
    inputs:
      node-version:
        description: Node version to use
        required: false
        default: '20'
        type: string
      jdk-version:
        description: Java version (AGP 8.x requires 17)
        required: false
        default: '17'
        type: string

jobs:
  compile-android:
    name: Compile Android
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Create .env from repository secrets
        run: |
          cat > .env <<'EOF'
          FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}
          EOF
          chmod 600 .env

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: ${{ inputs['node-version'] }}
          cache: 'npm'

      - name: Install deps
        run: npm ci

      # Generate android/ from Expo config (CNG) so Gradle can compile
      - name: Expo prebuild (Android)
        env:
          EXPO_NO_INTERACTIVE: '1'
        run: npx expo prebuild --platform android --non-interactive
        # Expo's Continuous Native Generation creates native projects on demand.

      # JDK 17 is required by modern Android Gradle Plugin (8.x)
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ inputs['jdk-version'] }}

      # Smarter Gradle caching/telemetry on GitHub Actions
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Fast compile-only to catch Java/Kotlin errors (no packaging)
      - name: Compile Android sources (Debug)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew :app:compileDebugSources --build-cache || \
          ./gradlew :app:compileDebugKotlin :app:compileDebugJavaWithJavac --build-cache
      
      # Build APK Debug (no sign)
      - name: Build APK (Debug)
        working-directory: android
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleDebug --build-cache --no-daemon --stacktrace

      # Upload artifact APK
      - name: Upload APK artifact (Debug)
        uses: actions/upload-artifact@v4
        with:
          name: app-Debug-${{ github.sha }}.apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 14



  